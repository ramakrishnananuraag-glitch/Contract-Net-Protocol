# Contract Net Protocol - Real-World Integration Example generated by AI

A comprehensive implementation of the Contract Net Protocol (CNP) in a warehouse logistics scenario, demonstrating detailed integration aspects including timing metrics, decision-making processes, and interactive visualization.

## ğŸ¯ What Makes This Implementation Different

Instead of just showing the bidding algorithm, this implementation demonstrates:

1. **Full System Integration** - How CNP fits into a real multi-agent system
2. **Performance Tracking** - Every decision point is timed and recorded
3. **Multi-Criteria Evaluation** - Realistic bid evaluation beyond simple cost comparison
4. **Agent Characteristics** - Each agent has skills, location, capacity, and efficiency factors
5. **Interactive Visualization** - Real-time parameter tuning and analysis

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CNP System Layer                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  ContractorAgent          Tasks Queue        ContracteeAgentsâ”‚
â”‚  (Manager)                                   (Workers)        â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Announce     â”‚â”€â”€â”€â”€â”€â”€â”€>â”‚ Task 1   â”‚       â”‚ Robot 1  â”‚   â”‚
â”‚  â”‚ Task         â”‚        â”‚ Task 2   â”‚       â”‚ Robot 2  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ Task 3   â”‚       â”‚ Forklift â”‚   â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ Drone    â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚ Collect Bids â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Evaluate     â”‚â”€â”€â”€â”€â”€â”€â”€>â”‚ Multi-Criteria Scoring       â”‚  â”‚
â”‚  â”‚ Bids         â”‚        â”‚ - Cost weight                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ - Time weight                â”‚  â”‚
â”‚                          â”‚ - Confidence weight          â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚ Award        â”‚                                            â”‚
â”‚  â”‚ Contract     â”‚â”€â”€â”€â”€â”€â”€â”€> Winner executes task              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Metrics Collection
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Performance Metrics                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Announcement time          â€¢ Bidding duration              â”‚
â”‚ â€¢ Bid generation times       â€¢ Evaluation time               â”‚
â”‚ â€¢ Award time                 â€¢ Completion time               â”‚
â”‚ â€¢ Number of bids             â€¢ Costs (winning vs average)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ Installation

### Prerequisites
- Python 3.8 or higher
- pip package manager

### Step 1: Install Dependencies

```bash
pip install streamlit pandas plotly numpy
```

### Step 2: Verify Installation

```bash
python -c "import streamlit; print(f'Streamlit version: {streamlit.__version__}')"
```

## ğŸš€ Running the Application

### Quick Start

```bash
streamlit run app.py
```

The application will open in your browser at `http://localhost:8501`

### Command Line Options

```bash
# Run on specific port
streamlit run app.py --server.port 8502

# Run in headless mode (server only, no browser)
streamlit run app.py --server.headless true

# Enable development mode with auto-reload
streamlit run app.py --server.runOnSave true
```

## ğŸ® Using the Simulator

### 1. Configure System Parameters

**Agent Configuration:**
- **Picking Robots**: Specialized in pick, pack, and sort operations
- **Forklifts**: Specialized in transport and heavy lifting
- **Drones**: Fast but limited capacity, good for light transport

**Task Configuration:**
- **Number of Tasks**: Total tasks to simulate (5-50)
- **% High Priority**: Percentage of tasks with priority 4-5
- **Duration Range**: Task execution time range in seconds

**CNP Behavior:**
- **Cost Weight**: How much cost influences bid selection (0-1)
- **Time Weight**: How much estimated time influences selection (0-1)
- **Confidence Weight**: Automatically calculated as 1 - cost - time

### 2. Run Simulation

Click "ğŸš€ Run Simulation" to execute a complete CNP cycle for all tasks.

### 3. Analyze Results

Explore five analysis tabs:

**â±ï¸ Processing Times**
- Timeline visualization showing CNP phases
- Detailed breakdown of bid generation, evaluation, and execution times
- Statistical distributions and outliers

**ğŸ“Š Bidding Analysis**
- Number of bids received per task
- Cost comparison (winning bid vs. average)
- Bidding patterns and trends

**ğŸ¤– Agent Performance**
- Tasks completed by each agent
- Efficiency factors and workload distribution
- Agent specialization effectiveness

**ğŸ—ºï¸ Task Allocation Map**
- Spatial visualization of warehouse
- Agent and task locations
- Allocation patterns

**ğŸ“‹ Raw Data**
- Complete performance data tables
- Download options for further analysis

## ğŸ” Understanding the Code

### Core Components

#### 1. Message System (`Message` class)
```python
Message(
    msg_id="unique_id",
    msg_type=MessageType.TASK_ANNOUNCEMENT,
    sender_id="manager",
    receiver_id="robot_01",
    task_id="task_001",
    content={'task': task_object},
    timestamp=time.time()
)
```
All agent communication goes through structured messages.

#### 2. Task Representation (`Task` class)
```python
Task(
    task_id="task_001",
    task_type="pick",              # Type of warehouse operation
    priority=4,                    # 1-5 urgency scale
    location=(25, 30),             # Warehouse coordinates
    required_skills=['pick'],      # Skills needed
    estimated_duration=10.5,       # Expected time in seconds
    deadline=timestamp,            # Must complete by
    status=TaskStatus.ANNOUNCED    # Current state
)
```

#### 3. Bid Evaluation (`evaluate_and_bid` method)

Each agent evaluates tasks considering:
- **Skill Match**: Does agent have required skills?
- **Capacity**: Can agent take on more work?
- **Distance**: Travel cost to task location
- **Current Workload**: How busy is the agent?
- **Efficiency**: Agent's individual performance factor

```python
# Cost calculation
distance_cost = distance * 2
workload_penalty = self.current_workload * 10
urgency_bonus = (5 - task.priority) * 5
total_cost = distance_cost + workload_penalty + urgency_bonus

# Confidence calculation
skill_confidence = 0.9 if extra_skills else 0.7
workload_confidence = 1.0 - (workload / max_capacity) * 0.3
confidence = skill_confidence * workload_confidence
```

#### 4. Multi-Criteria Bid Selection

The contractor evaluates bids using weighted scoring:

```python
# Normalize each criterion (0-1 scale)
cost_score = 1 - (bid.cost / max_cost)
time_score = 1 - (bid.estimated_time / max_time)
confidence_score = bid.confidence

# Apply weights based on priority
if task.priority >= 4:
    # High priority: favor speed and reliability
    total_score = 0.2*cost + 0.4*time + 0.4*confidence
else:
    # Normal priority: balanced approach
    total_score = 0.4*cost + 0.3*time + 0.3*confidence
```

### Performance Metrics Collection

#### Timing Metrics

Every phase is timed:
```python
metrics = PerformanceMetrics(
    announcement_time=time.time(),
    bidding_start_time=time.time(),
    bidding_end_time=0,
    evaluation_start_time=0,
    evaluation_end_time=0,
    award_time=0,
    completion_time=0
)
```

#### Processing Time Recording

```python
# Bid generation (per agent)
bid_start = time.time()
bid = agent.evaluate_and_bid(task)
bid_time = time.time() - bid_start
metrics.bid_generation_times.append(bid_time)

# Bid evaluation (contractor)
metrics.evaluation_start_time = time.time()
winning_bid = evaluate_bids(task_id)
metrics.evaluation_end_time = time.time()
metrics.bid_evaluation_time = metrics.evaluation_end_time - metrics.evaluation_start_time
```

## ğŸ§ª Experiments to Try

### Experiment 1: Agent Quantity Impact
1. Run with 2 robots, 1 forklift, 1 drone (10 tasks)
2. Run with 8 robots, 6 forklifts, 4 drones (10 tasks)
3. Compare:
   - Average bids per task
   - Winning bid costs
   - Bid evaluation time

**Expected Result**: More agents â†’ more bids â†’ higher evaluation time but lower costs

### Experiment 2: Priority Effect
1. Set 0% high priority tasks
2. Set 100% high priority tasks
3. Compare winning agents and cost patterns

**Expected Result**: High priority tasks get allocated to faster/more reliable agents

### Experiment 3: Evaluation Weights
1. Set cost_weight=0.8, time_weight=0.1 (cost-focused)
2. Set cost_weight=0.1, time_weight=0.8 (time-focused)
3. Compare average winning costs and completion times

**Expected Result**: Weights directly influence which agents win contracts

### Experiment 4: System Scaling
1. Run with 5 tasks, 4 robots
2. Run with 25 tasks, 4 robots
3. Run with 50 tasks, 4 robots
4. Observe agent workload distribution

**Expected Result**: Agents become bottleneck; some tasks may get no bids

### Experiment 5: Task Complexity
1. Duration range: 1-5 seconds (simple tasks)
2. Duration range: 15-30 seconds (complex tasks)
3. Compare total system throughput

**Expected Result**: Complex tasks create longer queues and reduce parallelism

## ğŸ“Š Key Metrics Explained

### Bidding Duration
Time from task announcement to receiving all bids. Affected by:
- Number of agents (more agents = slightly longer)
- Agent computation complexity
- Network/system delays (simulated)

### Bid Evaluation Time
Time for contractor to analyze all bids and select winner. Affected by:
- Number of bids received
- Complexity of scoring algorithm
- Data normalization overhead

### Total CNP Time
Complete cycle from announcement to task completion:
```
Total = Bidding + Evaluation + Execution
```

### Cost Savings
Difference between average bid cost and winning bid cost:
```
Savings = (Average of all bids) - (Winning bid)
```
Shows efficiency of bid selection process.

### Agent Efficiency Factor
Individual agent performance multiplier (0.8 - 1.2):
- <1.0: Agent is faster than average
- >1.0: Agent is slower than average

Simulates real-world agent variability.

## ğŸ“ Learning Exercises

### Exercise 1: Add New Agent Type
Add a "Supervisor" agent that can handle any task type but at higher cost:

```python
agent = ContracteeAgent(
    agent_id="supervisor_01",
    agent_type="supervisor",
    skills=['pick', 'pack', 'transport', 'sort', 'inspect'],
    location=(25, 25),  # Central location
    max_capacity=5
)
```

Modify bid generation to add a premium for versatility.

### Exercise 2: Implement Task Clustering
Group nearby tasks and award them to the same agent for efficiency.

### Exercise 3: Add Communication Costs
Simulate message passing delays based on agent distance.

### Exercise 4: Implement Learning
Track agent success rates and adjust confidence over time.

### Exercise 5: Add Resource Constraints
Limit total system capacity (e.g., only 10 tasks can run simultaneously).

## ğŸ› Troubleshooting

### Application won't start
```bash
# Check Streamlit installation
pip show streamlit

# Reinstall if needed
pip install --upgrade streamlit
```

### Import errors
```bash
# Install all dependencies
pip install streamlit pandas plotly numpy
```

### Performance issues
- Reduce number of tasks (<30)
- Reduce number of agents (<15)
- Close other browser tabs

### Graphs not displaying
- Clear browser cache
- Try different browser (Chrome recommended)
- Check console for JavaScript errors

## ğŸ“š Further Reading

### Contract Net Protocol
- Smith, R. G. (1980). "The Contract Net Protocol: High-Level Communication and Control in a Distributed Problem Solver"
- Foundation for multi-agent task allocation

### Multi-Agent Systems
- Distributed AI and coordination mechanisms
- Auction-based resource allocation
- Market-based approaches

### Real-World Applications
- Warehouse automation and logistics
- Drone swarm coordination
- Smart manufacturing
- Cloud computing resource allocation

## ğŸ¤ Contributing

Ideas for improvements:
1. Dynamic task priorities
2. Agent failure handling
3. Re-bidding mechanisms
4. Historical performance tracking
5. Predictive task routing
6. Multi-task bundles
7. Agent coalitions

## ğŸ“ License

This is an educational example. Feel free to use and modify for learning purposes.

## ğŸ’¡ Key Takeaways

1. **CNP is more than bidding**: Integration requires message passing, state management, and coordination
2. **Timing matters**: Every decision has computational cost that affects system scalability
3. **Trade-offs exist**: Cost vs. time vs. reliability - no perfect solution
4. **Context matters**: Evaluation criteria should adapt to task priority and system state
5. **Metrics drive improvement**: Detailed tracking reveals bottlenecks and optimization opportunities
